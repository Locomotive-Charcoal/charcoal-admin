<?php

namespace Charcoal\Admin\Widget;

use \RuntimeException;
use \InvalidArgumentException;

// From Pimple
use \Pimple\Container;

// From 'charcoal-factory'
use \Charcoal\Factory\FactoryInterface;

// From `charcoal-property`
use \Charcoal\Property\PropertyInterface;

// From 'charcoal-translation'
use \Charcoal\Translation\TranslationConfig;

// From 'charcoal-ui'
use \Charcoal\Ui\FormGroup\FormGroupInterface;
use \Charcoal\Ui\FormGroup\FormGroupTrait;
use \Charcoal\Ui\FormInput\FormInputInterface;
use \Charcoal\Ui\Layout\LayoutAwareInterface;
use \Charcoal\Ui\Layout\LayoutAwareTrait;


// From 'charcoal-admin'
use \Charcoal\Admin\AdminWidget;

/**
 *
 */
class FormPropertyWidget extends AdminWidget implements
    FormInputInterface
{
    /**
     * Store the form control property instance.
     *
     * @var PropertyInputInterface|null
     */
    private $inputProperty;

    /**
     * Store the display property instance.
     *
     * @var PropertyDisplayInterface|null
     */
    private $displayProperty;

    /**
     * @var string $type
     */
    protected $type;

    /**
     * The display property type.
     *
     * @var string|null
     */
    protected $displayType;

    /**
     * The form control property type.
     *
     * @var string|null
     */
    protected $inputType;

    /**
     * @var array $inputOptions
     */
    protected $inputOptions;

    /**
     * @var string $propertyIdent
     */
    private $propertyIdent;

    /**
     * @var mixed $propertyVal
     */
    private $propertyVal;

    /**
     * @var array $propertyData
     */
    private $propertyData = [];

    /**
     * @var PropertyInterface $property
     */
    private $property;

    /**
     * @var boolean $active
     */
    private $active = true;

    /**
     * @var string $l10nMode
     */
    private $l10nMode;

    /**
     * The form group the control belongs to.
     *
     * @var FormGroupInterface
     */
    protected $formGroup;

    /**
     * Store the property factory instance.
     *
     * @var PropertyFactory
     */
    private $propertyFactory;

    /**
     * Store the form control property factory instance.
     *
     * @var FactoryInterface
     */
    private $propertyInputFactory;

    /**
     * Store the display property factory instance.
     *
     * @var FactoryInterface
     */
    private $propertyDisplayFactory;

    /**
     * @param  Container $container Pimple DI container.
     * @return void
     */
    public function setDependencies(Container $container)
    {
        parent::setDependencies($container);

        $this->setPropertyFactory($container['property/factory']);
        $this->setPropertyInputFactory($container['property/input/factory']);
        $this->setPropertyDisplayFactory($container['property/display/factory']);
    }

    /**
     * Set a property factory.
     *
     * @param FactoryInterface $factory The property factory,
     *     to createable property values.
     * @return self
     */
    protected function setPropertyFactory(FactoryInterface $factory)
    {
        $this->propertyFactory = $factory;

        return $this;
    }

    /**
     * Retrieve the property factory.
     *
     * @throws RuntimeException If the property factory was not previously set.
     * @return FactoryInterface
     */
    public function propertyFactory()
    {
        if (!isset($this->propertyFactory)) {
            throw new RuntimeException(
                sprintf('Property Factory is not defined for "%s"', get_class($this))
            );
        }

        return $this->propertyFactory;
    }

    /**
     * Set a property control factory.
     *
     * @param FactoryInterface $factory The property control factory,
     *     to create controlable property values.
     * @return self
     */
    protected function setPropertyInputFactory(FactoryInterface $factory)
    {
        $this->propertyInputFactory = $factory;

        return $this;
    }

    /**
     * Retrieve the property control factory.
     *
     * @throws RuntimeException If the property control factory was not previously set.
     * @return FactoryInterface
     */
    public function propertyInputFactory()
    {
        if (!isset($this->propertyInputFactory)) {
            throw new RuntimeException(
                sprintf('Property Input Factory is not defined for "%s"', get_class($this))
            );
        }

        return $this->propertyInputFactory;
    }

    /**
     * Set a property display factory.
     *
     * @param FactoryInterface $factory The property display factory,
     *     to create displayable property values.
     * @return self
     */
    protected function setPropertyDisplayFactory(FactoryInterface $factory)
    {
        $this->propertyDisplayFactory = $factory;

        return $this;
    }

    /**
     * Retrieve the property display factory.
     *
     * @throws RuntimeException If the property display factory was not previously set.
     * @return FactoryInterface
     */
    public function propertyDisplayFactory()
    {
        if (!isset($this->propertyDisplayFactory)) {
            throw new RuntimeException(
                sprintf('Property Display Factory is not defined for "%s"', get_class($this))
            );
        }

        return $this->propertyDisplayFactory;
    }

    /**
     * Set the form input's parent group.
     *
     * @param  FormGroupInterface $formGroup The parent form group object.
     * @return FormPropertyWidget Chainable
     */
    public function setFormGroup(FormGroupInterface $formGroup)
    {
        $this->formGroup = $formGroup;

        return $this;
    }

    /**
     * Retrieve the input's parent group.
     *
     * @return FormGroupInterface
     */
    public function formGroup()
    {
        return $this->formGroup;
    }

    /**
     * Clear the input's parent group.
     *
     * @return FormPropertyWidget Chainable
     */
    public function clearFormGroup()
    {
        $this->formGroup = null;

        return $this;
    }

    /**
     * Set the widget and property data.
     *
     * @param  array|ArrayAccess $data Widget and property data.
     * @return FormPropertyWidget Chainable
     */
    public function setData($data)
    {
        parent::setData($data);

        // Keep the data in copy, this will be passed to the property and/or input later
        $this->propertyData = $data;

        return $this;
    }

    /**
     * Merge widget and property data.
     *
     * @param  array|\Traversable $data Widget and property data.
     * @return FormPropertyWidget Chainable
     */
    public function merge($data)
    {
        $this->propertyData = array_replace($this->propertyData, $data);

        return $this;
    }

    /**
     * @param  boolean $active The active flag.
     * @return FormPropertyWidget Chainable
     */
    public function setActive($active)
    {
        $this->active = !!$active;
        return $this;
    }

    /**
     * @return boolean
     */
    public function active()
    {
        return $this->active;
    }

    /**
     * Set the form's property identifier.
     *
     * @param  string $propertyIdent The property identifier.
     * @throws InvalidArgumentException If the property ident is not a string.
     * @return FormPropertyWidget Chainable
     */
    public function setPropertyIdent($propertyIdent)
    {
        if (!is_string($propertyIdent)) {
            throw new InvalidArgumentException(
                'Property identifier must be a string'
            );
        }

        $this->propertyIdent = $propertyIdent;

        return $this;
    }

    /**
     * Retrieve the form's property identifier.
     *
     * @return string
     */
    public function propertyIdent()
    {
        return $this->propertyIdent;
    }

    /**
     * @param  mixed $propertyVal The property value.
     * @return FormPropertyWidget Chainable
     */
    public function setPropertyVal($propertyVal)
    {
        $this->propertyVal = $propertyVal;
        return $this;
    }

    /**
     * @return mixed
     */
    public function propertyVal()
    {
        return $this->propertyVal;
    }

    /**
     * @return boolean
     */
    public function showLabel()
    {
        return true;
    }

    /**
     * @return boolean
     */
    public function showDescription()
    {
        $description = $this->prop()->description();
        return !!$description;
    }

    /**
     * @return boolean
     */
    public function showNotes()
    {
        $prop = $this->prop();
        $show = $prop['show_notes'];

        if ($show === false) {
            return false;
        }

        $notes = $this->prop()->notes();

        return !!$notes;
    }

    /**
     * @return boolean
     */
    public function showNotesAbove()
    {
        $prop = $this->prop();
        $show = $prop['show_notes'];

        if ($show !== 'above') {
            return false;
        }

        $notes = $this->prop()->notes();

        return !!$notes;
    }

    /**
     * @return TranslationString|string|null
     */
    public function description()
    {
        return $this->prop()->description();
    }

    /**
     * @return TranslationString|string|null
     */
    public function notes()
    {
        return $this->prop()->notes();
    }

    /**
     * Set the display property type.
     *
     * @param  string $type The property input type.
     * @return FormPropertyWidget Chainable
     */
    public function setDisplayType($type)
    {
        $this->displayType = $type;

        return $this;
    }

    /**
     * Retrieve the display property type.
     *
     * @return string
     */
    public function displayType()
    {
        if ($this->displayType === null) {
            $prop     = $this->prop();
            $metadata = $prop->metadata();

            $type = (isset($metadata['admin']) ? $metadata['admin']['display_type'] : '');
            if (!$type) {
                $type = 'charcoal/admin/property/display/text';
            }

            $this->displayType = $type;
        }
        return $this->displayType;
    }

    /**
     * @return string
     */
    public function inputId()
    {
        return 'input_id';
    }

    /**
     * @return string
     */
    public function inputName()
    {
        return 'input_name';
    }

    /**
     * Set the form control property type.
     *
     * @param  string $type The property input type.
     * @return FormPropertyWidget Chainable
     */
    public function setInputType($type)
    {
        $this->inputType = $type;

        return $this;
    }

    /**
     * Retrieve the form control property type.
     *
     * @return string
     */
    public function inputType()
    {
        if ($this->inputType === null) {
            $prop     = $this->prop();
            $metadata = $prop->metadata();

            $type = (isset($metadata['admin']) ? $metadata['admin']['input_type'] : '');

            if (!$type) {
                $type = 'charcoal/admin/property/input/text';
            }

            $this->inputType = $type;
        }
        return $this->inputType;
    }

    /**
     * @param  PropertyInterface $property The property.
     * @return FormPropertyWidget Chainable
     */
    public function setProp(PropertyInterface $property)
    {
        $this->property = $property;
        return $this;
    }

    /**
     * @return PropertyInterface
     */
    public function prop()
    {
        if ($this->property === null) {
            $p = $this->propertyFactory()->create($this->type());

            $p->setIdent($this->propertyIdent());
            $p->setData($this->propertyData);

            $this->property = $p;
        }

        return $this->property;
    }

    /**
     * @return array
     */
    public function availableLanguages()
    {
        $trans = TranslationConfig::instance();

        return $trans->availableLanguages();
    }

    /**
     * Determine if the form control's active language should be displayed.
     *
     * @return boolean
     */
    public function showActiveLanguage()
    {
        $prop  = $this->prop();
        $trans = TranslationConfig::instance();

        return ($trans->isMultilingual() && $prop->l10n());
    }

    /**
     * @param  string $mode The l10n mode.
     * @return FormPropertyWidget Chainable
     */
    public function setL10nMode($mode)
    {
        $this->l10nMode = $mode;
        return $this;
    }

    /**
     * @return string
     */
    public function l10nMode()
    {
        return $this->l10nMode;
    }

    /**
     * @return boolean
     */
    public function loopL10n()
    {
        return ($this->l10nMode() == 'loop_inputs');
    }

    /**
     * Retrieve the form control property.
     *
     * @return PropertyInputInterface
     */
    public function input()
    {
        $inputType = $this->inputType();

        if ($this->inputProperty === null) {
            $prop = $this->prop();

            /** @todo Needs fix. Must be manually triggered after setting data for metadata to work */
            $metadata = $prop->metadata();

            $input = $this->propertyInputFactory()->create($inputType);

            if ($this->formGroup() && ($input instanceof FormInputInterface)) {
                $input->setFormGroup($this->formGroup());
            }

            if (isset($metadata['admin'])) {
                $input->setData($metadata['admin']);
            }

            $input->setInputType($inputType);
            $input->setProperty($prop);
            $input->setPropertyVal($this->propertyVal);
            $input->setData($prop->data());
            $input->setViewController($this->viewController());

            $this->inputProperty = $input;
        } else {
            $input = $this->inputProperty;
        }

        $GLOBALS['widget_template'] = $input->template();

        if ($this->loopL10n() && $prop->l10n()) {
            $langs = $this->availableLanguages();
            $inputId = $input->inputId();
            foreach ($langs as $lang) {
                // Set a unique input ID for language.
                $input->setInputId($inputId.'_'.$lang);
                $input->setLang($lang);

                yield $input;
            }
            $input->setInputId($inputId);
        } else {
            yield $input;
        }
    }

    /**
     * Retrieve the display property.
     *
     * @return PropertyDisplayInterface
     */
    public function display()
    {
        $displayType = $this->displayType();

        if ($this->displayProperty === null) {
            $prop = $this->prop();

            /** @todo Needs fix. Must be manually triggered after setting data for metadata to work */
            $metadata = $prop->metadata();

            $display = $this->propertyDisplayFactory()->create($displayType);

            if ($this->formGroup() && ($display instanceof FormInputInterface)) {
                $display->setFormGroup($this->formGroup());
            }

            if (isset($metadata['admin'])) {
                $display->setData($metadata['admin']);
            }

            $display->setDisplayType($displayType);
            $display->setProperty($prop);
            $display->setPropertyVal($this->propertyVal);
            $display->setData($prop->data());
            $display->setViewController($this->viewController());

            $this->displayProperty = $display;
        } else {
            $display = $this->displayProperty;
        }

        $GLOBALS['widget_template'] = $display->template();

        if ($this->loopL10n() && $prop->l10n()) {
            $langs = $this->availableLanguages();
            $displayId = $display->displayId();
            foreach ($langs as $lang) {
                // Set a unique display ID for language.
                $display->setDisplayId($displayId.'_'.$lang);
                $display->setLang($lang);

                yield $display;
            }
            $display->setDisplayId($displayId);
        } else {
            yield $display;
        }
    }
}

